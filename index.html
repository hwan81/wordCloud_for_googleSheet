<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Google Sheets ì›Œë“œí´ë¼ìš°ë“œ ìƒì„±ê¸°</title>
  <style>
    /* ì „ì²´ í™”ë©´ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
    #wordcloud-section:fullscreen, #wordcloud-section:-webkit-full-screen, #wordcloud-section:-moz-full-screen {
        background-color: #f7fafc;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding: 1rem;
        overflow-y: auto; /* ë‚´ìš©ì´ ë§ì„ ê²½ìš° ìŠ¤í¬ë¡¤ */
    }
    
    #wordcloud-container svg {
        max-width: 95%; 
        height: auto;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">

  <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg mb-8">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">
      Google Sheets ì›Œë“œí´ë¼ìš°ë“œ ìƒì„±ê¸°
    </h1>

    <div class="mb-6">
      <label for="sheetUrl" class="block text-sm font-medium text-gray-700 mb-2">
        Google Sheets URL ì…ë ¥
      </label>
      <input type="url" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/..."
             class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
             required>
      <p class="mt-1 text-sm text-red-500">
        <b>í•„ìˆ˜</b>: ì‹œíŠ¸ê°€ 'ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ë³´ê¸°' ê¶Œí•œìœ¼ë¡œ ê³µìœ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.<br>
        B1ì—´ì€ ì œëª©ìœ¼ë¡œ ì‚¬ìš©ë˜ë©°, B2 ì´í•˜ì˜ ë‚´ìš©ì´ ì¶œë ¥ë©ë‹ˆë‹¤.
      </p>
    </div>

    <button id="connectButton" onclick="startProcessing()"
            class="w-full flex items-center justify-center bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-200 ease-in-out shadow-md focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
      ì‹œíŠ¸ ì—°ê²° ë° ë°ì´í„° ì²˜ë¦¬
    </button>
    
    <div id="result" class="mt-4"></div>
  </div>
  
  <div id="wordcloud-section" class="w-full max-w-6xl bg-white p-6 rounded-xl shadow-2xl transition-all duration-300">
    <div class="relative text-center mb-4 border-b pb-2">
      <h2 id="wordcloud-title" class="text-3xl font-bold text-gray-800">
          ë°ì´í„°ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.
      </h2>
      <div class="absolute top-0 right-0">
        <button id="fullscreen-btn" onclick="toggleFullScreen()"
                class="flex items-center space-x-2 bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150 text-sm focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50">
            <svg id="fullscreen-icon-open" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m7-5v4m0 0h4M20 4l-5 5m-5 9v4m0 0H7M12 20l-5-5m12 5l-5-5m5 5h-4m4 0v-4M20 20l-5-5"></path></svg>
            <svg id="fullscreen-icon-close" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            <span id="fullscreen-text">ì „ì²´ í™”ë©´</span>
        </button>
      </div>
    </div>
    
    <div id="wordcloud-container" class="flex justify-center items-center text-gray-500">
        ì—¬ê¸°ì— ì›Œë“œí´ë¼ìš°ë“œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
    </div>
  </div>

  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-cloud@1.2.5/build/d3.layout.cloud.min.js"></script>
  <script>
    let pollingInterval;
    let lastDataString = '';
    let currentFrequencyData = null; // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì¬ì‚¬ìš©í•  í˜„ì¬ ë°ì´í„° ì €ì¥ ë³€ìˆ˜
    let refreshRate = 5; // ìƒˆë¡œê³ ì¹¨ ì£¼ê¸°(ì´ˆ)

    function startProcessing() {
      if (pollingInterval) clearInterval(pollingInterval);
      processSheet();
      pollingInterval = setInterval(processSheet, refreshRate * 1000); 
    }
    
    function processSheet() {
      const sheetUrl = document.getElementById('sheetUrl').value;
      if (!sheetUrl) return;

      if (!lastDataString) {
        const connectButton = document.getElementById('connectButton');
        const resultDiv = document.getElementById('result');
        connectButton.disabled = true;
        connectButton.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>ë°ì´í„° ì²˜ë¦¬ ì¤‘...';
        resultDiv.innerHTML = '<p class="text-center text-blue-500 mt-2">ë°ì´í„°ë¥¼ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>';
      }
      
      google.script.run
        .withSuccessHandler(showResults)
        .withFailureHandler(showError)
        .processSheetData(sheetUrl);
    }

    function showResults(data) {
      if (data.error) {
        showError(data.error);
        return;
      }
      
      const newDataString = JSON.stringify(data.frequencyData);

      if (newDataString !== lastDataString) {
        console.log("ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ê°ì§€í•˜ì—¬ ì›Œë“œí´ë¼ìš°ë“œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.");
        lastDataString = newDataString;
        currentFrequencyData = data.frequencyData; // í˜„ì¬ ë°ì´í„°ë¥¼ ë³€ìˆ˜ì— ì €ì¥

        document.getElementById('wordcloud-title').textContent = data.title;
        createOrUpdateWordCloud(currentFrequencyData);

        const connectButton = document.getElementById('connectButton');
        if (connectButton.disabled) {
            const resultDiv = document.getElementById('result');
            connectButton.disabled = false;
            connectButton.innerHTML = 'ì‹œíŠ¸ ì—°ê²° ë° ë°ì´í„° ì²˜ë¦¬';
            resultDiv.innerHTML = `
              <div class="p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg text-center">
                <p class="font-bold">âœ… ë°ì´í„° ì—°ê²° ì„±ê³µ!</p>
                <p>ì´ì œ 5ì´ˆë§ˆë‹¤ ìë™ìœ¼ë¡œ ë°ì´í„° ë³€ê²½ì„ ê°ì§€í•©ë‹ˆë‹¤.</p>
              </div>
            `;
            document.getElementById('wordcloud-section').scrollIntoView({ behavior: 'smooth' });
        }
      } else {
        console.log("ë°ì´í„° ë³€ê²½ ì—†ìŒ. (5ì´ˆë§ˆë‹¤ í™•ì¸ ì¤‘)");
      }
    }

    function showError(error) {
      if (pollingInterval) clearInterval(pollingInterval);
      
      const connectButton = document.getElementById('connectButton');
      connectButton.disabled = false;
      connectButton.innerHTML = 'ì‹œíŠ¸ ì—°ê²° ë° ë°ì´í„° ì²˜ë¦¬';
      
      const errorMessage = typeof error === 'string' ? error : error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      document.getElementById('result').innerHTML = `
        <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
          <p class="font-bold">âŒ ì˜¤ë¥˜ ë°œìƒ:</p>
          <p>${errorMessage}</p>
        </div>
      `;
      console.error("Apps Script ì˜¤ë¥˜:", errorMessage);
    }

    function createOrUpdateWordCloud(data) {
      if (!data) return;

      const container = d3.select("#wordcloud-container");
      
      const margin = { top: 10, right: 10, bottom: 10, left: 10 };
      // í˜„ì¬ ì»¨í…Œì´ë„ˆì˜ ì‹¤ì œ ë„ˆë¹„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
      const width = document.getElementById('wordcloud-container').clientWidth - margin.left - margin.right;
      // ğŸ‘‡ ë¸Œë¼ìš°ì € ì°½ ë†’ì´ì˜ 95%ë¥¼ ì°¨ì§€í•˜ë„ë¡ ìˆ˜ì •
      const height = window.innerHeight * 0.95 - margin.top - margin.bottom;
      const maxFrequency = d3.max(data, d => d.frequency) || 1;
      const minFrequency = d3.min(data, d => d.frequency) || 1;
      // í°íŠ¸ í¬ê¸° ë²”ìœ„ ìˆ˜ì •
      const fontSizeScale = d3.scaleLinear()
        .domain([minFrequency, maxFrequency])
        .range([30, 150]); 

      const colorScale = d3.scaleOrdinal(d3.schemeSet3);
      
      let svg = container.select("svg");
      let g;
      if (svg.empty()) {
        container.html('');
        svg = container.append("svg");
        g = svg.append("g");
      } else {
        g = svg.select("g");
      }

      // SVGì™€ ê·¸ë£¹(g)ì˜ í¬ê¸° ë° ìœ„ì¹˜ ì—…ë°ì´íŠ¸
      svg.attr("width", width + margin.left + margin.right)
         .attr("height", height + margin.top + margin.bottom);
      g.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");


      const layout = d3.layout.cloud()
        .size([width, height])
        .words(data.map(d => ({ text: d.item, size: fontSizeScale(d.frequency) })))
        .padding(5)
        .rotate(() => Math.floor(Math.random() * 6) * 20 - 60)
        .font("Impact")
        .fontSize(d => d.size)
        .on("end", draw);

      layout.start();

      function draw(words) {
        const text = g.selectAll("text").data(words, d => d.text);

        text.enter().append("text")
          .style("font-family", "Impact")
          // .style("fill", (d, i) => colorScale(d.text))
          .style("fill", (d, i) => colorScale(i))
          .attr("text-anchor", "middle")
          .text(d => d.text)
          .style("font-size", "1px")
          .merge(text) // Enterì™€ Update ì„ íƒì„ ë³‘í•©í•˜ì—¬ ì• ë‹ˆë©”ì´ì…˜ì„ í•œ ë²ˆì— ì²˜ë¦¬
          .transition()
          .duration(1000)
          .style("font-size", d => d.size + "px")
          .attr("transform", d => `translate(${d.x},${d.y})rotate(${d.rotate})`);
          
        text.exit()
          .transition()
          .duration(1000)
          .style("font-size", "1px")
          .style("fill-opacity", 1e-6)
          .remove();
      }
    }

    function toggleFullScreen() {
      const section = document.getElementById('wordcloud-section');
      if (!document.fullscreenElement) {
        section.requestFullscreen().catch(err => {
            alert(`ì „ì²´ í™”ë©´ ëª¨ë“œë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${err.message} (${err.name})`);
        });
      } else {
        document.exitFullscreen();
      }
    }

    // ì „ì²´ í™”ë©´ ìƒíƒœ ë³€ê²½ ê°ì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.addEventListener('fullscreenchange', () => {
      const textEl = document.getElementById('fullscreen-text');
      const openIcon = document.getElementById('fullscreen-icon-open');
      const closeIcon = document.getElementById('fullscreen-icon-close');

      if (document.fullscreenElement) {
        console.log("ì „ì²´ í™”ë©´ ëª¨ë“œ ì§„ì…. ì›Œë“œí´ë¼ìš°ë“œë¥¼ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.");
        textEl.textContent = "í™”ë©´ ì¢…ë£Œ";
        openIcon.classList.add('hidden');
        closeIcon.classList.remove('hidden');
      } else {
        console.log("ì „ì²´ í™”ë©´ ëª¨ë“œ í•´ì œ. ì›Œë“œí´ë¼ìš°ë“œë¥¼ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.");
        textEl.textContent = "ì „ì²´ í™”ë©´";
        openIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
      }

      // í™”ë©´ í¬ê¸° ë³€ê²½ì´ DOMì— ë°˜ì˜ë  ì‹œê°„ì„ ì ì‹œ ê¸°ë‹¤ë¦° í›„ ë‹¤ì‹œ ê·¸ë¦¼
      setTimeout(() => {
        if (currentFrequencyData) {
          createOrUpdateWordCloud(currentFrequencyData);
        }
      }, 150);
    });
  </script>

</body>
</html>
